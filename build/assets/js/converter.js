"use strict";

var key = '83f45781b9cd2d13dd16';
var api = 'https://free.currconv.com/api/v7';
var form = document.querySelector('#screen-form');
var selTo = form.querySelector('select[name=countries-to]');
var selFrom = form.querySelector('select[name=countries-from]');
var input = form.querySelector('input[name=amount]');
var result = document.querySelector('#result');
var rate = document.querySelector('#rate');
var lastUp = document.querySelector('#last-update');
var image = './assets/imgs/flags';
var locale = 'en-US';
var formatterOpts = {
  style: 'decimal',
  minimumFractionDigits: 2,
  maximumFractionDigits: 2
};
/**
 * Update the app with the total result obtained after conversion
 * @param {Number} total The total output of the result
 * @param {Number|null} r the rate at which the currency was converted
 * @param {Number} time last update timestamp
 */

function updateResult(total, time) {
  var r = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : null;
  total = new Intl.NumberFormat(locale, formatterOpts).format(total);
  result.setAttribute('data-result', total);
  result.innerText = total;

  if (r) {
    rate.innerText = "".concat(r.toFixed(2), " ").concat(selFrom.value, " per ").concat(selTo.value);
  } else {
    rate.innerText = '';
  }

  lastUp.innerText = time ? timeDiff(time) : '';
}
/**
 * Convert between currencies. 
 * This function will be probably called when button input is made
 */


function convertCurrency() {
  var from = selFrom.value.toUpperCase();
  var to = selTo.value.toUpperCase();
  var amount = input.value;
  var timestamp = new Date().getTime();
  var query = "".concat(from, "_").concat(to);
  var rate, total; // we don't want to perform any conversion if we have a zero amount or we are converting between the same currency

  if (amount > 0 && from != to) {
    // we have just 100 requests per hour on the free currency converter plan. We have to use it wisely
    // check the database for rate and use the rate found in the database
    var dbPromise = database();
    dbPromise.then(function (db) {
      var tx = db.transaction('rates');
      var rates = tx.objectStore('rates');
      return rates.get(query);
    }).then(function (result) {
      // if there was no result from the database query fetch from the network
      if (!result) return fetch("".concat(api, "/convert?apiKey=").concat(key, "&q=").concat(query, "&compact=ultra"));
      var dbRate = result.rate;
      console.log('using rate from database');
      rate = dbRate;
      total = amount * rate;
      updateResult(total, result.timestamp, rate);
    }).then(function (result) {
      if (!result) return; // do nothing if no fetch to the network was made

      console.log('fetched rate from network');
      return result.json();
    }).then(function (data) {
      if (!data) return;
      if (data.error) throw new Error('free api limit reached'); //data error could be "Free API limit reached"

      rate = data[query];
      total = amount * rate;
      updateResult(total, timestamp, rate);
      return database();
    }).then(function (db) {
      if (!db) return;
      var tx = db.transaction('rates', 'readwrite');
      tx.objectStore('rates').put({
        query: query,
        rate: rate,
        timestamp: timestamp
      });
      return tx.complete;
    }).then(function () {
      console.log('updating table');
    })["catch"](function (err) {
      console.info(err);
    })["finally"](function () {// stop spinner
    });
  } else {
    // no input or input is less than 0
    updateResult(0);
  }
}
/**
 * Get all currencies and its neccessary details from our api
 */


function getCurrencies() {
  // load all currencies
  var getCurrencies = fetch("".concat(api, "/currencies?apiKey=").concat(key));
  getCurrencies.then(function (response) {
    return response.json();
  }).then(function (currencies) {
    if (currencies.error) throw new Error('free api limit reached'); // currencies.error could be "free api limit reached"
    // store the currencies in an array so we can sort it alphabetically

    var arr = Object.keys(currencies.results);
    arr = arr.sort();
    var id = 0;
    var selIndex = 0;
    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = arr[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        var _key = _step.value;
        var currency = currencies.results[_key];
        var option = document.createElement('option');
        option.value = currency.id.toLowerCase();
        option.setAttribute('data-id', ++id);
        option.setAttribute('data-image', "".concat(image, "/").concat(currency.id.toLowerCase(), ".png"));
        option.text = currency.id;
        selTo.appendChild(option); // use usd as selected index

        if (currency.id == 'USD') {
          selIndex = id - 1;
          selTo.selectedIndex = selIndex;
        }
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator["return"] != null) {
          _iterator["return"]();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    return currencies;
  }).then(function (currencies) {
    var arr = Object.keys(currencies.results);
    arr = arr.sort();
    var id = 0;
    var selIndex = 0;
    var _iteratorNormalCompletion2 = true;
    var _didIteratorError2 = false;
    var _iteratorError2 = undefined;

    try {
      for (var _iterator2 = arr[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
        var _key2 = _step2.value;
        var currency = currencies.results[_key2];
        var option = document.createElement('option');
        option.value = currency.id.toLowerCase();
        option.setAttribute('data-id', ++id);
        option.setAttribute('data-image', "".concat(image, "/").concat(currency.id.toLowerCase(), ".png"));
        option.text = currency.id;
        selFrom.appendChild(option); // use usd as selected index

        if (currency.id == 'GBP') {
          selIndex = id - 1;
          selFrom.selectedIndex = selIndex;
        }
      }
    } catch (err) {
      _didIteratorError2 = true;
      _iteratorError2 = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion2 && _iterator2["return"] != null) {
          _iterator2["return"]();
        }
      } finally {
        if (_didIteratorError2) {
          throw _iteratorError2;
        }
      }
    }

    return;
  }).then(function () {
    // re instantiate the select js class to update the custom select div with currencies
    return new Selectjs();
  })["catch"](function (err) {
    console.info(err);
  });
}

;

function timeDiff(then) {
  if (!then) throw new Error('parameter 1 required');
  if (!then instanceof Date || typeof then !== 'number') throw new Error('parameter 1 should be an instance of Date or a number type');
  var now = new Date().getTime();
  then = then instanceof Date ? then.getTime() : then;
  var secDiff = parseInt((now - then) / 1000); //convert from milliseconds to seconds

  var perMin = 60;
  var perHour = perMin * 60;
  var perDay = perHour * 24;
  var perWeek = perDay * 7;
  var perMonth = perWeek * 4;
  var perYear = perMonth * 12;
  var timeDiff;

  switch (true) {
    case secDiff === 0:
      timeDiff = 'now';
      break;

    case secDiff < perMin:
      // less than a min
      timeDiff = "".concat(secDiff, "s ago");
      break;

    case secDiff < perHour:
      // less than an hour
      timeDiff = "".concat(parseInt(secDiff / perMin), "m ago");
      break;

    case secDiff < perDay:
      // less than a day
      timeDiff = "".concat(parseInt(secDiff / perHour), "h ago");
      break;

    case secDiff < perWeek:
      timeDiff = "".concat(parseInt(secDiff / perDay), "d ago");
      break;

    case secDiff < perMonth:
      timeDiff = "".concat(parseInt(secDiff / perWeek), "w ago");
      break;

    case secDiff < perYear:
      timeDiff = "".concat(parseInt(secDiff / perWeek), "mth ago");
      break;

    case secDiff >= perYear:
      timeDiff = "".concat(parseInt(secDiff / perYear), "y ago"); //@todo get stuffs like 1y6mth ago
      //tip: if secDiff/perYear is not a whole number then convert the remaining decimal to months

      break;
  }

  return timeDiff;
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbnZlcnRlci5qcyJdLCJuYW1lcyI6WyJrZXkiLCJhcGkiLCJmb3JtIiwiZG9jdW1lbnQiLCJxdWVyeVNlbGVjdG9yIiwic2VsVG8iLCJzZWxGcm9tIiwiaW5wdXQiLCJyZXN1bHQiLCJyYXRlIiwibGFzdFVwIiwiaW1hZ2UiLCJsb2NhbGUiLCJmb3JtYXR0ZXJPcHRzIiwic3R5bGUiLCJtaW5pbXVtRnJhY3Rpb25EaWdpdHMiLCJtYXhpbXVtRnJhY3Rpb25EaWdpdHMiLCJ1cGRhdGVSZXN1bHQiLCJ0b3RhbCIsInRpbWUiLCJyIiwiSW50bCIsIk51bWJlckZvcm1hdCIsImZvcm1hdCIsInNldEF0dHJpYnV0ZSIsImlubmVyVGV4dCIsInRvRml4ZWQiLCJ2YWx1ZSIsInRpbWVEaWZmIiwiY29udmVydEN1cnJlbmN5IiwiZnJvbSIsInRvVXBwZXJDYXNlIiwidG8iLCJhbW91bnQiLCJ0aW1lc3RhbXAiLCJEYXRlIiwiZ2V0VGltZSIsInF1ZXJ5IiwiZGJQcm9taXNlIiwiZGF0YWJhc2UiLCJ0aGVuIiwiZGIiLCJ0eCIsInRyYW5zYWN0aW9uIiwicmF0ZXMiLCJvYmplY3RTdG9yZSIsImdldCIsImZldGNoIiwiZGJSYXRlIiwiY29uc29sZSIsImxvZyIsImpzb24iLCJkYXRhIiwiZXJyb3IiLCJFcnJvciIsInB1dCIsImNvbXBsZXRlIiwiZXJyIiwiaW5mbyIsImdldEN1cnJlbmNpZXMiLCJyZXNwb25zZSIsImN1cnJlbmNpZXMiLCJhcnIiLCJPYmplY3QiLCJrZXlzIiwicmVzdWx0cyIsInNvcnQiLCJpZCIsInNlbEluZGV4IiwiY3VycmVuY3kiLCJvcHRpb24iLCJjcmVhdGVFbGVtZW50IiwidG9Mb3dlckNhc2UiLCJ0ZXh0IiwiYXBwZW5kQ2hpbGQiLCJzZWxlY3RlZEluZGV4IiwiU2VsZWN0anMiLCJub3ciLCJzZWNEaWZmIiwicGFyc2VJbnQiLCJwZXJNaW4iLCJwZXJIb3VyIiwicGVyRGF5IiwicGVyV2VlayIsInBlck1vbnRoIiwicGVyWWVhciJd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QUFNa0QsT0FBTixVQUFSO0FBQ0E7O0FBQ0osU0FBS0EsT0FBTyxHQUFHRyxPQUFmO0FBQXdCO0FBQ3BCckQsTUFBQUEsUUFBUSxhQUFNbUQsUUFBUSxDQUFDRCxPQUFPLEdBQUNFLE1BQVQsQ0FBZCxVQUFSO0FBQ0E7O0FBQ0osU0FBS0YsT0FBTyxHQUFHSSxNQUFmO0FBQXVCO0FBQ25CdEQsTUFBQUEsUUFBUSxhQUFNbUQsUUFBUSxDQUFDRCxPQUFPLEdBQUNHLE9BQVQsQ0FBZCxVQUFSO0FBQ0E7O0FBQ0osU0FBS0gsT0FBTyxHQUFHSyxPQUFmO0FBQ0l2RCxNQUFBQSxRQUFRLGFBQU1tRCxRQUFRLENBQUNELE9BQU8sR0FBQ0ksTUFBVCxDQUFkLFVBQVI7QUFDQTs7QUFDSixTQUFLSixPQUFPLEdBQUdNLFFBQWY7QUFDSXhELE1BQUFBLFFBQVEsYUFBTW1ELFFBQVEsQ0FBQ0QsT0FBTyxHQUFDSyxPQUFULENBQWQsVUFBUjtBQUNBOztBQUNKLFNBQUtMLE9BQU8sR0FBR08sT0FBZjtBQUNJekQsTUFBQUEsUUFBUSxhQUFNbUQsUUFBUSxDQUFDRCxPQUFPLEdBQUNLLE9BQVQsQ0FBZCxZQUFSO0FBQ0E7O0FBQ0osU0FBS0wsT0FBTyxJQUFJTyxPQUFoQjtBQUNJekQsTUFBQUEsUUFBUSxhQUFNbUQsUUFBUSxDQUFDRCxPQUFPLEdBQUNPLE9BQVQsQ0FBZCxVQUFSLENBREosQ0FFSTtBQUNBOztBQUNBO0FBMUJSOztBQTRCQSxTQUFPekQsUUFBUDtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3Qga2V5ID0gJzgzZjQ1NzgxYjljZDJkMTNkZDE2JztcclxuY29uc3QgYXBpID0gJ2h0dHBzOi8vZnJlZS5jdXJyY29udi5jb20vYXBpL3Y3JztcclxuY29uc3QgZm9ybSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNzY3JlZW4tZm9ybScpO1xyXG5jb25zdCBzZWxUbyA9IGZvcm0ucXVlcnlTZWxlY3Rvcignc2VsZWN0W25hbWU9Y291bnRyaWVzLXRvXScpO1xyXG5jb25zdCBzZWxGcm9tID0gZm9ybS5xdWVyeVNlbGVjdG9yKCdzZWxlY3RbbmFtZT1jb3VudHJpZXMtZnJvbV0nKTtcclxuY29uc3QgaW5wdXQgPSBmb3JtLnF1ZXJ5U2VsZWN0b3IoJ2lucHV0W25hbWU9YW1vdW50XScpO1xyXG5jb25zdCByZXN1bHQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcmVzdWx0Jyk7XHJcbmNvbnN0IHJhdGUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcmF0ZScpO1xyXG5jb25zdCBsYXN0VXAgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjbGFzdC11cGRhdGUnKTtcclxuY29uc3QgaW1hZ2UgPSAnLi9hc3NldHMvaW1ncy9mbGFncyc7XHJcbmNvbnN0IGxvY2FsZSA9ICdlbi1VUyc7XHJcbmNvbnN0IGZvcm1hdHRlck9wdHMgPSB7XHJcbiAgICBzdHlsZTogJ2RlY2ltYWwnLFxyXG4gICAgbWluaW11bUZyYWN0aW9uRGlnaXRzOiAyLFxyXG4gICAgbWF4aW11bUZyYWN0aW9uRGlnaXRzOiAyXHJcbn07XHJcblxyXG4vKipcclxuICogVXBkYXRlIHRoZSBhcHAgd2l0aCB0aGUgdG90YWwgcmVzdWx0IG9idGFpbmVkIGFmdGVyIGNvbnZlcnNpb25cclxuICogQHBhcmFtIHtOdW1iZXJ9IHRvdGFsIFRoZSB0b3RhbCBvdXRwdXQgb2YgdGhlIHJlc3VsdFxyXG4gKiBAcGFyYW0ge051bWJlcnxudWxsfSByIHRoZSByYXRlIGF0IHdoaWNoIHRoZSBjdXJyZW5jeSB3YXMgY29udmVydGVkXHJcbiAqIEBwYXJhbSB7TnVtYmVyfSB0aW1lIGxhc3QgdXBkYXRlIHRpbWVzdGFtcFxyXG4gKi9cclxuZnVuY3Rpb24gdXBkYXRlUmVzdWx0KHRvdGFsLCB0aW1lLCByPW51bGwpe1xyXG4gICAgdG90YWwgPSBuZXcgSW50bC5OdW1iZXJGb3JtYXQobG9jYWxlLCBmb3JtYXR0ZXJPcHRzKS5mb3JtYXQodG90YWwpO1xyXG4gICAgcmVzdWx0LnNldEF0dHJpYnV0ZSgnZGF0YS1yZXN1bHQnLCB0b3RhbCk7XHJcbiAgICByZXN1bHQuaW5uZXJUZXh0ID0gdG90YWw7XHJcbiAgICBpZihyKXtcclxuICAgICAgICByYXRlLmlubmVyVGV4dCA9IGAke3IudG9GaXhlZCgyKX0gJHtzZWxGcm9tLnZhbHVlfSBwZXIgJHtzZWxUby52YWx1ZX1gO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICByYXRlLmlubmVyVGV4dCA9ICcnO1xyXG4gICAgfVxyXG4gICAgbGFzdFVwLmlubmVyVGV4dCA9IHRpbWUgPyB0aW1lRGlmZih0aW1lKSA6ICcnO1xyXG59XHJcblxyXG4vKipcclxuICogQ29udmVydCBiZXR3ZWVuIGN1cnJlbmNpZXMuIFxyXG4gKiBUaGlzIGZ1bmN0aW9uIHdpbGwgYmUgcHJvYmFibHkgY2FsbGVkIHdoZW4gYnV0dG9uIGlucHV0IGlzIG1hZGVcclxuICovXHJcbmZ1bmN0aW9uIGNvbnZlcnRDdXJyZW5jeSgpe1xyXG4gICAgbGV0IGZyb20gPSBzZWxGcm9tLnZhbHVlLnRvVXBwZXJDYXNlKCk7XHJcbiAgICBsZXQgdG8gPSBzZWxUby52YWx1ZS50b1VwcGVyQ2FzZSgpO1xyXG4gICAgbGV0IGFtb3VudCA9IGlucHV0LnZhbHVlO1xyXG4gICAgbGV0IHRpbWVzdGFtcCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xyXG4gICAgbGV0IHF1ZXJ5ID0gYCR7ZnJvbX1fJHt0b31gO1xyXG4gICAgbGV0IHJhdGUsIHRvdGFsO1xyXG5cclxuICAgIC8vIHdlIGRvbid0IHdhbnQgdG8gcGVyZm9ybSBhbnkgY29udmVyc2lvbiBpZiB3ZSBoYXZlIGEgemVybyBhbW91bnQgb3Igd2UgYXJlIGNvbnZlcnRpbmcgYmV0d2VlbiB0aGUgc2FtZSBjdXJyZW5jeVxyXG4gICAgaWYoYW1vdW50ID4gMCAmJiAoZnJvbSAhPSB0bykpe1xyXG5cclxuICAgICAgICAvLyB3ZSBoYXZlIGp1c3QgMTAwIHJlcXVlc3RzIHBlciBob3VyIG9uIHRoZSBmcmVlIGN1cnJlbmN5IGNvbnZlcnRlciBwbGFuLiBXZSBoYXZlIHRvIHVzZSBpdCB3aXNlbHlcclxuICAgICAgICAvLyBjaGVjayB0aGUgZGF0YWJhc2UgZm9yIHJhdGUgYW5kIHVzZSB0aGUgcmF0ZSBmb3VuZCBpbiB0aGUgZGF0YWJhc2VcclxuICAgICAgICBsZXQgZGJQcm9taXNlID0gZGF0YWJhc2UoKTtcclxuICAgICAgICBkYlByb21pc2UudGhlbihkYj0+e1xyXG4gICAgICAgICAgICBjb25zdCB0eCA9IGRiLnRyYW5zYWN0aW9uKCdyYXRlcycpO1xyXG4gICAgICAgICAgICBjb25zdCByYXRlcyA9IHR4Lm9iamVjdFN0b3JlKCdyYXRlcycpO1xyXG4gICAgICAgICAgICByZXR1cm4gcmF0ZXMuZ2V0KHF1ZXJ5KTtcclxuICAgICAgICB9KS50aGVuKHJlc3VsdD0+e1xyXG4gICAgICAgICAgICAvLyBpZiB0aGVyZSB3YXMgbm8gcmVzdWx0IGZyb20gdGhlIGRhdGFiYXNlIHF1ZXJ5IGZldGNoIGZyb20gdGhlIG5ldHdvcmtcclxuICAgICAgICAgICAgaWYoIXJlc3VsdCkgcmV0dXJuIGZldGNoKGAke2FwaX0vY29udmVydD9hcGlLZXk9JHtrZXl9JnE9JHtxdWVyeX0mY29tcGFjdD11bHRyYWApO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgbGV0IGRiUmF0ZSA9IHJlc3VsdC5yYXRlO1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygndXNpbmcgcmF0ZSBmcm9tIGRhdGFiYXNlJyk7XHJcbiAgICAgICAgICAgIHJhdGUgPSBkYlJhdGU7XHJcbiAgICAgICAgICAgIHRvdGFsID0gYW1vdW50ICogcmF0ZTtcclxuICAgICAgICAgICAgdXBkYXRlUmVzdWx0KHRvdGFsLCByZXN1bHQudGltZXN0YW1wLCByYXRlKTtcclxuICAgICAgICB9KS50aGVuKHJlc3VsdD0+e1xyXG5cclxuICAgICAgICAgICAgaWYoIXJlc3VsdCkgcmV0dXJuOyAvLyBkbyBub3RoaW5nIGlmIG5vIGZldGNoIHRvIHRoZSBuZXR3b3JrIHdhcyBtYWRlXHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdmZXRjaGVkIHJhdGUgZnJvbSBuZXR3b3JrJyk7XHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQuanNvbigpO1xyXG5cclxuICAgICAgICB9KS50aGVuKGRhdGE9PntcclxuICAgICAgICAgICAgaWYoIWRhdGEpIHJldHVybjtcclxuICAgICAgICAgICAgaWYgKGRhdGEuZXJyb3IpIHRocm93IG5ldyBFcnJvcignZnJlZSBhcGkgbGltaXQgcmVhY2hlZCcpOyAgLy9kYXRhIGVycm9yIGNvdWxkIGJlIFwiRnJlZSBBUEkgbGltaXQgcmVhY2hlZFwiXHJcbiAgICAgICAgICAgIHJhdGUgPSBkYXRhW3F1ZXJ5XTtcclxuICAgICAgICAgICAgdG90YWwgPSBhbW91bnQgKiByYXRlO1xyXG4gICAgICAgICAgICB1cGRhdGVSZXN1bHQodG90YWwsIHRpbWVzdGFtcCwgcmF0ZSk7XHJcbiAgICAgICAgICAgIHJldHVybiBkYXRhYmFzZSgpO1xyXG4gICAgICAgIH0pLnRoZW4oKGRiKT0+e1xyXG4gICAgICAgICAgICBpZighZGIpIHJldHVybjtcclxuICAgICAgICAgICAgY29uc3QgdHggPSBkYi50cmFuc2FjdGlvbigncmF0ZXMnLCAncmVhZHdyaXRlJyk7XHJcbiAgICAgICAgICAgIHR4Lm9iamVjdFN0b3JlKCdyYXRlcycpLnB1dCh7cXVlcnksIHJhdGUsIHRpbWVzdGFtcH0pO1xyXG4gICAgICAgICAgICByZXR1cm4gdHguY29tcGxldGU7XHJcbiAgICAgICAgfSkudGhlbigoKT0+e1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygndXBkYXRpbmcgdGFibGUnKVxyXG4gICAgICAgIH0pLmNhdGNoKGVycj0+e1xyXG4gICAgICAgICAgICBjb25zb2xlLmluZm8oZXJyKTtcclxuICAgICAgICB9KS5maW5hbGx5KCgpPT57XHJcbiAgICAgICAgICAgIC8vIHN0b3Agc3Bpbm5lclxyXG4gICAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICAvLyBubyBpbnB1dCBvciBpbnB1dCBpcyBsZXNzIHRoYW4gMFxyXG4gICAgICAgIHVwZGF0ZVJlc3VsdCgwKTtcclxuICAgIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIEdldCBhbGwgY3VycmVuY2llcyBhbmQgaXRzIG5lY2Nlc3NhcnkgZGV0YWlscyBmcm9tIG91ciBhcGlcclxuICovXHJcbmZ1bmN0aW9uIGdldEN1cnJlbmNpZXMoKXtcclxuXHJcbiAgICAvLyBsb2FkIGFsbCBjdXJyZW5jaWVzXHJcbiAgICBjb25zdCBnZXRDdXJyZW5jaWVzID0gZmV0Y2goYCR7YXBpfS9jdXJyZW5jaWVzP2FwaUtleT0ke2tleX1gKTtcclxuICAgIGdldEN1cnJlbmNpZXMudGhlbihyZXNwb25zZT0+e1xyXG4gICAgICAgIHJldHVybiByZXNwb25zZS5qc29uKCk7XHJcbiAgICB9KS50aGVuKGN1cnJlbmNpZXM9PntcclxuXHJcbiAgICAgICAgaWYoY3VycmVuY2llcy5lcnJvcikgdGhyb3cgbmV3IEVycm9yKCdmcmVlIGFwaSBsaW1pdCByZWFjaGVkJyk7IC8vIGN1cnJlbmNpZXMuZXJyb3IgY291bGQgYmUgXCJmcmVlIGFwaSBsaW1pdCByZWFjaGVkXCJcclxuXHJcbiAgICAgICAgLy8gc3RvcmUgdGhlIGN1cnJlbmNpZXMgaW4gYW4gYXJyYXkgc28gd2UgY2FuIHNvcnQgaXQgYWxwaGFiZXRpY2FsbHlcclxuICAgICAgICBsZXQgYXJyID0gT2JqZWN0LmtleXMoY3VycmVuY2llcy5yZXN1bHRzKTtcclxuICAgICAgICBhcnIgPSBhcnIuc29ydCgpO1xyXG4gICAgICAgIGxldCBpZCA9IDA7XHJcbiAgICAgICAgbGV0IHNlbEluZGV4ID0gMDtcclxuICAgICAgICBmb3IobGV0IGtleSBvZiBhcnIpe1xyXG4gICAgICAgICAgICBsZXQgY3VycmVuY3kgPSBjdXJyZW5jaWVzLnJlc3VsdHNba2V5XTtcclxuICAgICAgICAgICAgbGV0IG9wdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpO1xyXG4gICAgICAgICAgICBvcHRpb24udmFsdWUgPSBjdXJyZW5jeS5pZC50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgICAgICBvcHRpb24uc2V0QXR0cmlidXRlKCdkYXRhLWlkJywgKytpZCk7XHJcbiAgICAgICAgICAgIG9wdGlvbi5zZXRBdHRyaWJ1dGUoJ2RhdGEtaW1hZ2UnLCBgJHtpbWFnZX0vJHtjdXJyZW5jeS5pZC50b0xvd2VyQ2FzZSgpfS5wbmdgKTtcclxuICAgICAgICAgICAgb3B0aW9uLnRleHQgPSBjdXJyZW5jeS5pZDtcclxuICAgICAgICAgICAgc2VsVG8uYXBwZW5kQ2hpbGQob3B0aW9uKTtcclxuICAgICAgICAgICAgLy8gdXNlIHVzZCBhcyBzZWxlY3RlZCBpbmRleFxyXG4gICAgICAgICAgICBpZihjdXJyZW5jeS5pZCA9PSAnVVNEJyl7XHJcbiAgICAgICAgICAgICAgICBzZWxJbmRleCA9IGlkIC0gMTtcclxuICAgICAgICAgICAgICAgIHNlbFRvLnNlbGVjdGVkSW5kZXggPSBzZWxJbmRleDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gY3VycmVuY2llcztcclxuICAgIH0pLnRoZW4oY3VycmVuY2llcz0+e1xyXG4gICAgICAgIGxldCBhcnIgPSBPYmplY3Qua2V5cyhjdXJyZW5jaWVzLnJlc3VsdHMpO1xyXG4gICAgICAgIGFyciA9IGFyci5zb3J0KCk7XHJcbiAgICAgICAgbGV0IGlkID0gMDtcclxuICAgICAgICBsZXQgc2VsSW5kZXggPSAwO1xyXG4gICAgICAgIGZvcihsZXQga2V5IG9mIGFycil7XHJcbiAgICAgICAgICAgIGxldCBjdXJyZW5jeSA9IGN1cnJlbmNpZXMucmVzdWx0c1trZXldO1xyXG4gICAgICAgICAgICBsZXQgb3B0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0aW9uJyk7XHJcbiAgICAgICAgICAgIG9wdGlvbi52YWx1ZSA9IGN1cnJlbmN5LmlkLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgICAgIG9wdGlvbi5zZXRBdHRyaWJ1dGUoJ2RhdGEtaWQnLCArK2lkKTtcclxuICAgICAgICAgICAgb3B0aW9uLnNldEF0dHJpYnV0ZSgnZGF0YS1pbWFnZScsIGAke2ltYWdlfS8ke2N1cnJlbmN5LmlkLnRvTG93ZXJDYXNlKCl9LnBuZ2ApO1xyXG4gICAgICAgICAgICBvcHRpb24udGV4dCA9IGN1cnJlbmN5LmlkO1xyXG4gICAgICAgICAgICBzZWxGcm9tLmFwcGVuZENoaWxkKG9wdGlvbik7XHJcbiAgICAgICAgICAgIC8vIHVzZSB1c2QgYXMgc2VsZWN0ZWQgaW5kZXhcclxuICAgICAgICAgICAgaWYoY3VycmVuY3kuaWQgPT0gJ0dCUCcpe1xyXG4gICAgICAgICAgICAgICAgc2VsSW5kZXggPSBpZCAtIDE7XHJcbiAgICAgICAgICAgICAgICBzZWxGcm9tLnNlbGVjdGVkSW5kZXggPSBzZWxJbmRleDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm47XHJcbiAgICB9KS50aGVuKCgpPT57XHJcbiAgICAgICAgLy8gcmUgaW5zdGFudGlhdGUgdGhlIHNlbGVjdCBqcyBjbGFzcyB0byB1cGRhdGUgdGhlIGN1c3RvbSBzZWxlY3QgZGl2IHdpdGggY3VycmVuY2llc1xyXG4gICAgICAgIHJldHVybiBuZXcgU2VsZWN0anMoKTtcclxuICAgIH0pLmNhdGNoKGVycj0+e1xyXG4gICAgICAgIGNvbnNvbGUuaW5mbyhlcnIpO1xyXG4gICAgfSk7XHJcbn07XHJcblxyXG5mdW5jdGlvbiB0aW1lRGlmZih0aGVuKXtcclxuICAgIGlmKCF0aGVuKSB0aHJvdyBuZXcgRXJyb3IoJ3BhcmFtZXRlciAxIHJlcXVpcmVkJyk7XHJcbiAgICBpZiAoIXRoZW4gaW5zdGFuY2VvZiBEYXRlIHx8IHR5cGVvZiB0aGVuICE9PSAnbnVtYmVyJykgdGhyb3cgbmV3IEVycm9yKCdwYXJhbWV0ZXIgMSBzaG91bGQgYmUgYW4gaW5zdGFuY2Ugb2YgRGF0ZSBvciBhIG51bWJlciB0eXBlJyk7XHJcbiAgICBsZXQgbm93ID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XHJcbiAgICB0aGVuID0gdGhlbiBpbnN0YW5jZW9mIERhdGUgPyB0aGVuLmdldFRpbWUoKSA6IHRoZW47XHJcbiAgICBsZXQgc2VjRGlmZiA9IHBhcnNlSW50KChub3cgLSB0aGVuKSAvIDEwMDApOyAvL2NvbnZlcnQgZnJvbSBtaWxsaXNlY29uZHMgdG8gc2Vjb25kc1xyXG4gICAgbGV0IHBlck1pbiA9IDYwO1xyXG4gICAgbGV0IHBlckhvdXIgPSBwZXJNaW4gKiA2MDtcclxuICAgIGxldCBwZXJEYXkgPSBwZXJIb3VyICogMjQ7XHJcbiAgICBsZXQgcGVyV2VlayA9IHBlckRheSAqIDc7XHJcbiAgICBsZXQgcGVyTW9udGggPSBwZXJXZWVrICogNDtcclxuICAgIGxldCBwZXJZZWFyID0gcGVyTW9udGggKiAxMjtcclxuICAgIFxyXG4gICAgbGV0IHRpbWVEaWZmO1xyXG4gICAgXHJcbiAgICBzd2l0Y2godHJ1ZSl7XHJcbiAgICAgICAgY2FzZSBzZWNEaWZmID09PSAwOlxyXG4gICAgICAgICAgICB0aW1lRGlmZiA9ICdub3cnO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlIHNlY0RpZmYgPCBwZXJNaW46IC8vIGxlc3MgdGhhbiBhIG1pblxyXG4gICAgICAgICAgICB0aW1lRGlmZiA9IGAke3NlY0RpZmZ9cyBhZ29gO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlIHNlY0RpZmYgPCBwZXJIb3VyOiAvLyBsZXNzIHRoYW4gYW4gaG91clxyXG4gICAgICAgICAgICB0aW1lRGlmZiA9IGAke3BhcnNlSW50KHNlY0RpZmYvcGVyTWluKX1tIGFnb2A7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2Ugc2VjRGlmZiA8IHBlckRheTogLy8gbGVzcyB0aGFuIGEgZGF5XHJcbiAgICAgICAgICAgIHRpbWVEaWZmID0gYCR7cGFyc2VJbnQoc2VjRGlmZi9wZXJIb3VyKX1oIGFnb2A7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2Ugc2VjRGlmZiA8IHBlcldlZWs6XHJcbiAgICAgICAgICAgIHRpbWVEaWZmID0gYCR7cGFyc2VJbnQoc2VjRGlmZi9wZXJEYXkpfWQgYWdvYDtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSBzZWNEaWZmIDwgcGVyTW9udGg6XHJcbiAgICAgICAgICAgIHRpbWVEaWZmID0gYCR7cGFyc2VJbnQoc2VjRGlmZi9wZXJXZWVrKX13IGFnb2A7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2Ugc2VjRGlmZiA8IHBlclllYXI6XHJcbiAgICAgICAgICAgIHRpbWVEaWZmID0gYCR7cGFyc2VJbnQoc2VjRGlmZi9wZXJXZWVrKX1tdGggYWdvYDtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSBzZWNEaWZmID49IHBlclllYXI6XHJcbiAgICAgICAgICAgIHRpbWVEaWZmID0gYCR7cGFyc2VJbnQoc2VjRGlmZi9wZXJZZWFyKX15IGFnb2A7XHJcbiAgICAgICAgICAgIC8vQHRvZG8gZ2V0IHN0dWZmcyBsaWtlIDF5Nm10aCBhZ29cclxuICAgICAgICAgICAgLy90aXA6IGlmIHNlY0RpZmYvcGVyWWVhciBpcyBub3QgYSB3aG9sZSBudW1iZXIgdGhlbiBjb252ZXJ0IHRoZSByZW1haW5pbmcgZGVjaW1hbCB0byBtb250aHNcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGltZURpZmY7XHJcbn0iXSwiZmlsZSI6ImNvbnZlcnRlci5qcyJ9
